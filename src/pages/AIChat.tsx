import { useState, useRef, useEffect, memo } from "react";
import { Send, Bot, User, AlertTriangle, Phone, Heart, Brain, MessageSquare, Lightbulb, Clock, Zap, Target, Shield, Mic, Plus, Upload, Image, Video, FileText, MicOff } from "lucide-react";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { ScrollArea } from "@/components/ui/scroll-area";
import { Badge } from "@/components/ui/badge";
import { Alert, AlertDescription } from "@/components/ui/alert";
import { Textarea } from "@/components/ui/textarea";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from "@/components/ui/dialog";
import { useToast } from "@/hooks/use-toast";
import { useLanguage } from "@/contexts/LanguageContext";
import SplineBackground from "@/components/SplineBackground";

// Memoized Spline background to prevent re-renders while typing
const MemoizedSplineBackground = memo(SplineBackground);


interface Message {
  id: string;
  text: string;
  sender: "user" | "ai";
  timestamp: Date;
  urgency?: "normal" | "high" | "emergency";
  attachments?: {
    type: "image" | "video" | "file";
    name: string;
    url: string;
    size?: number;
  }[];
}

const quickResponses = [
  "I'm feeling anxious about upcoming exams ЁЯУЪ",
  "Having trouble sleeping properly ЁЯШ┤",
  "Feeling overwhelmed with studies and pressure ЁЯШ░",
  "Missing home and family deeply ЁЯПа",
  "Struggling with hostel life adjustment ЁЯПв",
  "Need help managing competitive exam stress ЁЯУЦ",
  "Feeling lonely or socially isolated ЁЯШФ",
  "Worried about future career prospects ЁЯТ╝",
  "Having family expectations pressure ЁЯСитАНЁЯСйтАНЁЯСзтАНЁЯСж",
  "Dealing with financial stress ЁЯТ░"
];

const aiResponses = {
  anxiety: "рдореИрдВ рд╕рдордЭ рд╕рдХрддрд╛ рд╣реВрдВ рдХрд┐ рдЖрдк рдЪрд┐рдВрддрд┐рдд рдорд╣рд╕реВрд╕ рдХрд░ рд░рд╣реЗ рд╣реИрдВред рдпрд╣рд╛рдВ рдХреБрдЫ рддрддреНрдХрд╛рд▓ рддрдХрдиреАрдХреЗрдВ рд╣реИрдВ рдЬреЛ рдорджрдж рдХрд░ рд╕рдХрддреА рд╣реИрдВ: 4-7-8 рд╕рд╛рдВрд╕ рд▓реЗрдиреЗ рдХреА рддрдХрдиреАрдХ рдЖрдЬрд╝рдорд╛рдПрдВ (4 рддрдХ рд╕рд╛рдВрд╕ рд▓реЗрдВ, 7 рддрдХ рд░реЛрдХреЗрдВ, 8 рддрдХ рдЫреЛрдбрд╝реЗрдВ)ред рдпрд╛рдж рд░рдЦреЗрдВ, рдЪрд┐рдВрддрд╛ рдЕрд╕реНрдерд╛рдпреА рд╣реИ рдФрд░ рдЗрд╕реЗ рд╕рдВрднрд╛рд▓рд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред рдХреНрдпрд╛ рдЖрдк рдЪрд╛рд╣реЗрдВрдЧреЗ рдХрд┐ рдореИрдВ рдЖрдкрдХреЛ рдПрдХ рддреНрд╡рд░рд┐рдд рдЧреНрд░рд╛рдЙрдВрдбрд┐рдВрдЧ рдПрдХреНрд╕рд░рд╕рд╛рдЗрдЬрд╝ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдЧрд╛рдЗрдб рдХрд░реВрдВ? Remember, lakhs of students face similar challenges - you're not alone! ЁЯТЩ",
  sleep: "рдиреАрдВрдж рдХреА рд╕рдорд╕реНрдпрд╛рдПрдВ рдЫрд╛рддреНрд░реЛрдВ рдореЗрдВ рдЖрдо рд╣реИрдВред рдПрдХ рдмреЗрдбрдЯрд╛рдЗрдо рд░реВрдЯреАрди рдмрдирд╛рдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░реЗрдВ: рд╕реЛрдиреЗ рд╕реЗ 1 рдШрдВрдЯреЗ рдкрд╣рд▓реЗ рдХреЛрдИ рд╕реНрдХреНрд░реАрди рдирд╣реАрдВ, рдЕрдкрдиреЗ рдХрдорд░реЗ рдХреЛ рдардВрдбрд╛ рдФрд░ рдЕрдВрдзреЗрд░рд╛ рд░рдЦреЗрдВред Many Indian students find that light dinner, avoiding late-night tea/coffee, and reading something positive helps. Guided meditation apps in Hindi can also be very helpful! ЁЯШ┤",
  overwhelmed: "рдЕрднрд┐рднреВрдд рдорд╣рд╕реВрд╕ рдХрд░рдирд╛ рдЗрд╕ рдмрд╛рдд рдХрд╛ рд╕рдВрдХреЗрдд рд╣реИ рдХрд┐ рдЖрдк рдмрд╣реБрдд рдХреБрдЫ рд╕рдВрднрд╛рд▓ рд░рд╣реЗ рд╣реИрдВред рдЖрдЗрдП рдЗрд╕реЗ рддреЛрдбрд╝рддреЗ рд╣реИрдВ: рд╕рдмрд╕реЗ рдЬрд░реВрд░реА рдХрд╛рдо рдХреНрдпрд╛ рд╣реИ? рдХреНрдпрд╛ рд╣рдо рдЖрдкрдХреА рдЬрд┐рдореНрдореЗрджрд╛рд░рд┐рдпреЛрдВ рдХреЛ рдкреНрд░рд╛рдердорд┐рдХрддрд╛ рджреЗ рд╕рдХрддреЗ рд╣реИрдВ? Remember the Indian philosophy - 'рдпреЛрдЧ: рдХрд░реНрдорд╕реБ рдХреМрд╢рд▓рдореН' - skill in action. Take one step at a time. рдШрдмрд░рд╛рдирд╛ рдирд╣реАрдВ, рд╕рдм рдареАрдХ рд╣реЛ рдЬрд╛рдПрдЧрд╛! ЁЯМЯ",
  homesick: "рдШрд░ рдХреА рдпрд╛рдж рдЖрдирд╛ рдмрд┐рд▓реНрдХреБрд▓ рд╕рд╛рдорд╛рдиреНрдп рд╣реИ рдФрд░ рдпрд╣ рджрд┐рдЦрд╛рддрд╛ рд╣реИ рдХрд┐ рдЖрдкрдХреЗ рдкреНрд░реЗрдордкреВрд░реНрдг рд░рд┐рд╢реНрддреЗ рд╣реИрдВред Try video calling family during specific times, cook/eat familiar foods, find students from your state/region. Many hostels have regional groups - рдпрд╣ рдЖрдкрдХреЛ рдЕрдкрдирд╛рдкрди рджреЗрдЧрд╛ред рдЖрдкрдХреА рднрд╛рд╡рдирд╛рдПрдВ рдмрд┐рд▓реНрдХреБрд▓ рд╕рд╣реА рд╣реИрдВред ЁЯПаЁЯТЭ",
  pressure: "рд╕рд╛рдорд╛рдЬрд┐рдХ рджрдмрд╛рд╡ рдЪреБрдиреМрддреАрдкреВрд░реНрдг рд╣реЛ рд╕рдХрддрд╛ рд╣реИред рдпрд╛рдж рд░рдЦреЗрдВ, рдЖрдкрдХреА рдХреАрдордд рджреВрд╕рд░реЛрдВ рдХреА рдордВрдЬреВрд░реА рд╕реЗ рддрдп рдирд╣реАрдВ рд╣реЛрддреАред рдЕрдкрдиреЗ рдореВрд▓реНрдпреЛрдВ рдФрд░ рд╕реАрдорд╛рдУрдВ рдкрд░ рднрд░реЛрд╕рд╛ рдХрд░реЗрдВред 'рдирд╛' рдХрд╣рдирд╛ рдареАрдХ рд╣реИред As our elders say - 'рдЕрдкрдирд╛ рд░рд╛рд╕реНрддрд╛ рдЦреБрдж рдмрдирд╛рдУ'ред You have the strength to stay true to yourself! ЁЯТк",
  stress: "рддрдирд╛рд╡ рдкреНрд░рдмрдВрдзрди рдПрдХ рдРрд╕рд╛ рдХреМрд╢рд▓ рд╣реИ рдЬрд┐рд╕реЗ рд╣рдо рдорд┐рд▓рдХрд░ рд╡рд┐рдХрд╕рд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред Try: рдкреНрд░рд╛рдгрд╛рдпрд╛рдо, regular exercise, time management, рдФрд░ mindfulnessред рдмрдбрд╝реЗ рдХрд╛рдо рдХреЛ рдЫреЛрдЯреЗ рд╣рд┐рд╕реНрд╕реЛрдВ рдореЗрдВ рдмрд╛рдВрдЯреЗрдВред Remember - 'рдзреИрд░реНрдп рдХрд╛ рдлрд▓ рдореАрдард╛ рд╣реЛрддрд╛ рд╣реИ'ред What specific area would you like to focus on? ЁЯзШтАНтЩВя╕П",
  lonely: "рдЕрдХреЗрд▓рд╛рдкрди рдорд╣рд╕реВрд╕ рдХрд░рдирд╛ рдЗрд╕рдХрд╛ рдорддрд▓рдм рдирд╣реАрдВ рдХрд┐ рдЖрдкрдореЗрдВ рдХреБрдЫ рдЧрд▓рдд рд╣реИред Consider joining cultural clubs, sports, or volunteering. Sometimes one genuine friendship can change everything. Many successful people felt lonely during college - you're in good company! рдЖрдк рдорд┐рддреНрд░рддрд╛ рдФрд░ рд╕реНрдиреЗрд╣ рдХреЗ рдпреЛрдЧреНрдп рд╣реИрдВред ЁЯдЭЁЯТЩ",
  career: "Career uncertainty is very common among Indian students due to high competition. Remember, there are multiple paths to success - not just traditional onesред Focus on your strengths, explore internships, talk to seniors in different fields. 'рдХрд░реНрдо рдХрд░реЛ, рдлрд▓ рдХреА рдЪрд┐рдВрддрд╛ рдордд рдХрд░реЛ'ред Your efforts will bear fruit! ЁЯОп",
  family: "Family expectations can feel overwhelming sometimes. Remember, they want your happiness ultimatelyред Open communication helps - share your thoughts respectfullyред It's okay to have different dreamsред Many successful Indians took unconventional pathsред Balance respect for family with personal aspirationsред ЁЯСитАНЁЯСйтАНЁЯСзтАНЁЯСжЁЯТЩ",
  financial: "Financial stress is real and affects many studentsред Look into scholarships, part-time opportunities, and campus support servicesред Remember, temporary financial constraints don't define your futureред Many successful people overcame such challengesред Focus on long-term goals while managing present needsред ЁЯТ░ЁЯМЯ"
};

export default function AIChat() {
  const { t } = useLanguage();
  const [messages, setMessages] = useState<Message[]>([
    {
      id: "1",
      text: t('ai.welcome'),
      sender: "ai",
      timestamp: new Date(),
    },
  ]);
  const [inputMessage, setInputMessage] = useState("");
  const [isTyping, setIsTyping] = useState(false);
  const [chatMode, setChatMode] = useState<"quick" | "detailed">("quick");
  const [userMood, setUserMood] = useState<string>("");
  const [isRecording, setIsRecording] = useState(false);
  const [isFileDialogOpen, setIsFileDialogOpen] = useState(false);
  const messagesEndRef = useRef<HTMLDivElement>(null);
  const fileInputRef = useRef<HTMLInputElement>(null);
  const mediaRecorderRef = useRef<MediaRecorder | null>(null);
  const { toast } = useToast();

  // Removed automatic scrolling to keep page position stable

  const getAIResponse = (userMessage: string): { text: string; urgency: "normal" | "high" | "emergency" } => {
    const message = userMessage.toLowerCase();
    
    // Emergency keywords
    if (message.includes("suicide") || message.includes("kill myself") || message.includes("end it all") || message.includes("harm myself") || message.includes("рдорд░рдирд╛") || message.includes("рдЖрддреНрдорд╣рддреНрдпрд╛")) {
      return {
        text: "ЁЯЪи I'm very concerned about what you've shared. рдЖрдкрдХреА рдЬрд┐рдВрджрдЧреА рдХреАрдорддреА рд╣реИ рдФрд░ рд▓реЛрдЧ рдЖрдкрдХреА рдорджрдж рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВред Please reach out immediately: National Suicide Prevention Lifeline: 9152987821 | Campus Emergency: 1800-599-0019 | KIRAN Helpline: 1800-599-0019. рдЖрдк рдЕрдХреЗрд▓реЗ рдирд╣реАрдВ рд╣реИрдВ - help is available!",
        urgency: "emergency"
      };
    }

    // High urgency keywords  
    if (message.includes("panic") || message.includes("crisis") || message.includes("emergency") || message.includes("can't cope") || message.includes("рдмрд╣реБрдд рдкрд░реЗрд╢рд╛рди") || message.includes("panic attack")) {
      return {
        text: "I can hear that you're in distress right nowред While I'm here to help, please also consider: 1) Campus crisis line: 1800-599-0019, 2) Going to counseling center, 3) Trusted friend/family memberред Right now, try grounding: name 5 things you can see, 4 you can touch, 3 you can hear, 2 you can smell, 1 you can tasteред рд╕рд╛рдВрд╕ рд▓реЗрдВ - you will get through thisред ЁЯлВ",
        urgency: "high"
      };
    }

    // Enhanced keyword matching for Indian context
    if (message.includes("anxious") || message.includes("anxiety") || message.includes("exam") || message.includes("worry") || message.includes("рдЪрд┐рдВрддрд╛") || message.includes("рдкрд░реАрдХреНрд╖рд╛")) {
      return { text: aiResponses.anxiety, urgency: "normal" };
    }
    if (message.includes("sleep") || message.includes("tired") || message.includes("insomnia") || message.includes("рдиреАрдВрдж") || message.includes("рд╕реЛ рдирд╣реАрдВ")) {
      return { text: aiResponses.sleep, urgency: "normal" };
    }
    if (message.includes("overwhelmed") || message.includes("too much") || message.includes("stressed") || message.includes("рддрдирд╛рд╡") || message.includes("pressure")) {
      return { text: aiResponses.overwhelmed, urgency: "normal" };
    }
    if (message.includes("home") || message.includes("family") || message.includes("miss") || message.includes("рдШрд░") || message.includes("рдкрд░рд┐рд╡рд╛рд░") || message.includes("homesick")) {
      return { text: aiResponses.homesick, urgency: "normal" };
    }
    if (message.includes("lonely") || message.includes("alone") || message.includes("isolated") || message.includes("рдЕрдХреЗрд▓рд╛") || message.includes("рджреЛрд╕реНрдд рдирд╣реАрдВ")) {
      return { text: aiResponses.lonely, urgency: "normal" };
    }
    if (message.includes("future") || message.includes("career") || message.includes("uncertain") || message.includes("placement") || message.includes("job") || message.includes("рднрд╡рд┐рд╖реНрдп") || message.includes("рдиреМрдХрд░реА")) {
      return { text: aiResponses.career, urgency: "normal" };
    }
    if (message.includes("parents") || message.includes("expectations") || message.includes("family pressure") || message.includes("рдорд╛рддрд╛-рдкрд┐рддрд╛") || message.includes("рдЙрдореНрдореАрджреЗрдВ")) {
      return { text: aiResponses.family, urgency: "normal" };
    }
    if (message.includes("money") || message.includes("financial") || message.includes("fees") || message.includes("рдкреИрд╕реЗ") || message.includes("рдлреАрд╕")) {
      return { text: aiResponses.financial, urgency: "normal" };
    }

    // Default culturally-aware response
    return {
      text: "Thank you for sharing with meред рдореИрдВ рдЖрдкрдХреА рдмрд╛рдд рд╕рдордЭрдирд╛ рдЪрд╛рд╣рддрд╛ рд╣реВрдВред Can you tell me more about what you're experiencing? Whether it's academic stress, family expectations, hostel life, or anything else - I'm here to listen and supportред рдпрд╛рдж рд░рдЦреЗрдВ, help рдорд╛рдВрдЧрдирд╛ strength рдХрд╛ sign рд╣реИред If urgent, please contact emergency servicesред ЁЯдЧ",
      urgency: "normal"
    };
  };

  const handleSendMessage = (text: string) => {
    if (!text.trim()) return;

    const userMessage: Message = {
      id: Date.now().toString(),
      text,
      sender: "user", 
      timestamp: new Date(),
    };

    setMessages(prev => [...prev, userMessage]);
    setInputMessage("");
    setIsTyping(true);

    // Simulate AI thinking time
    setTimeout(() => {
      const response = getAIResponse(text);
      const aiMessage: Message = {
        id: (Date.now() + 1).toString(),
        text: response.text,
        sender: "ai",
        timestamp: new Date(),
        urgency: response.urgency,
      };

      setMessages(prev => [...prev, aiMessage]);
      setIsTyping(false);

      if (response.urgency === "emergency") {
        toast({
          title: "Emergency Support Available",
          description: "Crisis helplines are ready to help you right now.",
          variant: "destructive"
        });
      }
    }, 1500);
  };

  const handleQuickResponse = (text: string) => {
    handleSendMessage(text);
  };

  // Voice to text functionality
  const startRecording = async () => {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      const mediaRecorder = new MediaRecorder(stream);
      mediaRecorderRef.current = mediaRecorder;
      
      const audioChunks: BlobPart[] = [];
      
      mediaRecorder.ondataavailable = (event) => {
        audioChunks.push(event.data);
      };
      
      mediaRecorder.onstop = () => {
        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
        transcribeAudio(audioBlob);
        stream.getTracks().forEach(track => track.stop());
      };
      
      mediaRecorder.start();
      setIsRecording(true);
      
      toast({
        title: "Recording started",
        description: "Speak now... Click the mic again to stop."
      });
    } catch (error) {
      toast({
        title: "Microphone access denied",
        description: "Please allow microphone access to use voice input.",
        variant: "destructive"
      });
    }
  };

  const stopRecording = () => {
    if (mediaRecorderRef.current && isRecording) {
      mediaRecorderRef.current.stop();
      setIsRecording(false);
    }
  };

  const transcribeAudio = (audioBlob: Blob) => {
    // Simple mock transcription - in real app you'd use a service like Web Speech API or external service
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SpeechRecognition = (window as any).webkitSpeechRecognition || (window as any).SpeechRecognition;
      const recognition = new SpeechRecognition();
      
      recognition.continuous = false;
      recognition.interimResults = false;
      recognition.lang = 'en-US';
      
      recognition.onresult = (event: any) => {
        const transcript = event.results[0][0].transcript;
        setInputMessage(prev => prev + (prev ? ' ' : '') + transcript);
        toast({
          title: "Voice transcribed",
          description: "Your speech has been converted to text."
        });
      };
      
      recognition.onerror = () => {
        toast({
          title: "Speech recognition failed",
          description: "Could not transcribe your voice. Please try typing instead.",
          variant: "destructive"
        });
      };
      
      recognition.start();
    } else {
      // Fallback for demo purposes
      setInputMessage(prev => prev + (prev ? ' ' : '') + "[Voice message recorded - transcription not available in this browser]");
      toast({
        title: "Voice recorded",
        description: "Speech recognition not supported in this browser."
      });
    }
  };

  // File upload functionality
  const handleFileUpload = (event: React.ChangeEvent<HTMLInputElement>) => {
    const files = event.target.files;
    if (!files) return;

    Array.from(files).forEach(file => {
      if (file.size > 10 * 1024 * 1024) { // 10MB limit
        toast({
          title: "File too large",
          description: "Please select files smaller than 10MB.",
          variant: "destructive"
        });
        return;
      }

      const fileUrl = URL.createObjectURL(file);
      const fileType = file.type.startsWith('image/') ? 'image' : 
                      file.type.startsWith('video/') ? 'video' : 'file';

      const messageWithFile: Message = {
        id: Date.now().toString(),
        text: `Shared ${fileType}: ${file.name}`,
        sender: "user",
        timestamp: new Date(),
        attachments: [{
          type: fileType,
          name: file.name,
          url: fileUrl,
          size: file.size
        }]
      };

      setMessages(prev => [...prev, messageWithFile]);
      
      toast({
        title: "File uploaded",
        description: `${file.name} has been shared.`
      });
    });

    // Reset file input
    if (fileInputRef.current) {
      fileInputRef.current.value = '';
    }
    setIsFileDialogOpen(false);
  };

  const triggerFileUpload = (accept: string) => {
    if (fileInputRef.current) {
      fileInputRef.current.accept = accept;
      fileInputRef.current.click();
    }
  };

  return (
    <div className="min-h-screen flex flex-col">
      <div className="relative flex-1 flex flex-col bg-background">
        <MemoizedSplineBackground />
        
        {/* Stable Overlay Effects - Less Dynamic in Light Mode */}
        <div className="absolute inset-0 bg-gradient-to-br from-primary/3 via-transparent to-accent/3 pointer-events-none" />
        <div className="absolute inset-0 bg-[radial-gradient(circle_at_50%_50%,hsl(var(--primary)/0.05),transparent_70%)] pointer-events-none" />
        
        <div className="flex-1 pt-20 px-4 pb-8 max-w-7xl mx-auto w-full relative z-10">
        {/* Emergency Banner - Futuristic */}
        <Alert className="mb-8 bg-gradient-glass backdrop-blur-xl border border-destructive/30 shadow-cyber animate-fade-in">
          <AlertTriangle className="h-5 w-5 text-destructive animate-pulse" />
          <AlertDescription className="flex items-center justify-between">
            <div className="text-destructive font-medium">
              <strong className="text-destructive">{t('ai.emergency.title')}</strong> 
              <span className="text-muted-foreground ml-2">{t('ai.emergency.text')}</span>
            </div>
            <Button variant="emergency" size="sm" className="shadow-neon">
              <Phone className="h-4 w-4 mr-2" />
              {t('ai.emergency.call')}
            </Button>
          </AlertDescription>
        </Alert>

        <div className="grid lg:grid-cols-12 gap-8 items-stretch">
          {/* Enhanced Futuristic Sidebar - Positioned beside chat */}
           <div className="lg:col-span-4 flex animate-fade-in" style={{ animationDelay: "0.3s" }}>
            {/* Quick Responses */}
            <Card className="flex-1 bg-gradient-glass backdrop-blur-xl border border-primary/20 shadow-cyber hover:shadow-neon transition-all duration-500">
              <CardHeader className="pb-4">
                <CardTitle className="flex items-center gap-3 text-lg">
                  <div className="p-2 bg-gradient-cyber rounded-lg shadow-neon">
                    <Lightbulb className="h-5 w-5 text-white" />
                  </div>
                  <span className="bg-gradient-neon bg-clip-text text-transparent font-bold">Quick Start Topics</span>
                </CardTitle>
                <CardDescription className="text-muted-foreground/80">Common challenges Indian students face</CardDescription>
              </CardHeader>
              <CardContent className="space-y-3">
                {quickResponses.map((response, index) => (
                  <Button
                    key={index}
                    variant="glass-primary"
                    size="sm"
                    className="w-full text-left justify-start h-auto p-4 whitespace-normal hover:shadow-cyber hover:scale-[1.02] transition-all duration-300 animate-fade-in text-white"
                    style={{ animationDelay: `${index * 0.1}s` }}
                    onClick={() => handleQuickResponse(response)}
                  >
                    {response}
                  </Button>
                ))}
              </CardContent>
            </Card>

          </div>

          {/* Main Chat Area - Positioned beside sidebar */}
          <div className="lg:col-span-8 flex animate-fade-in">
            <Card className="h-full flex flex-col bg-gradient-glass backdrop-blur-xl border border-primary/20 shadow-cyber hover:shadow-neon transition-all duration-500">
              {/* Enhanced Futuristic Header */}
              <div className="bg-gradient-cyber text-white p-6 border-b border-primary/30 relative overflow-hidden">
                {/* Animated background elements */}
                <div className="absolute inset-0 bg-gradient-to-r from-primary/10 via-transparent to-accent/10 animate-pulse" />
                <div className="absolute top-0 left-0 w-full h-0.5 bg-gradient-neon" />
                
                <div className="relative flex items-center justify-between">
                  <div className="flex items-center space-x-4">
                    <div className="p-3 bg-gradient-glass backdrop-blur-md rounded-full border border-primary-glow/30 shadow-neon animate-float">
                      <Bot className="h-7 w-7 text-primary-glow" />
                    </div>
                    <div>
                      <h1 className="text-2xl font-bold bg-gradient-neon bg-clip-text text-transparent">
                        {t('ai.title')}
                      </h1>
                      <p className="text-sm text-primary-glow/80 font-medium">
                        {t('ai.subtitle')}
                      </p>
                    </div>
                  </div>
                  <div className="flex gap-3">
                    <Button
                      variant={chatMode === "quick" ? "neon" : "glass-primary"}
                      size="sm"
                      onClick={() => setChatMode("quick")}
                      className="hover:scale-105 transition-all duration-300"
                    >
                      <Zap className="h-4 w-4 mr-1" />
                      {t('ai.mode.quick')}
                    </Button>
                    <Button
                      variant={chatMode === "detailed" ? "neon" : "glass-primary"}
                      size="sm"
                      onClick={() => setChatMode("detailed")}
                      className="hover:scale-105 transition-all duration-300"
                    >
                      <Target className="h-4 w-4 mr-1" />
                      {t('ai.mode.detailed')}
                    </Button>
                  </div>
                </div>
              </div>

              {/* Messages with Glassmorphism */}
              <ScrollArea className="flex-1 p-6">
                <div className="space-y-6">
                  {messages.map((message, index) => (
                    <div
                      key={message.id}
                      className={`flex gap-4 ${message.sender === "user" ? "flex-row-reverse" : ""} animate-slide-up`}
                      style={{ animationDelay: `${index * 0.1}s` }}
                    >
                      <div className={`w-12 h-12 rounded-full flex items-center justify-center shadow-cyber transition-all duration-300 hover:scale-110 ${
                        message.sender === "user" 
                          ? "bg-gradient-neon text-background border border-primary-glow/30" 
                          : "bg-gradient-cyber text-white border border-primary-glow/30 animate-pulse-glow"
                      }`}>
                        {message.sender === "user" ? <User className="h-6 w-6" /> : <Bot className="h-6 w-6" />}
                      </div>
                      
                      <div className={`max-w-[75%] ${message.sender === "user" ? "text-right" : ""}`}>
                        <div className={`p-5 rounded-2xl backdrop-blur-lg transition-all duration-300 hover:scale-[1.02] ${
                          message.sender === "user"
                            ? "bg-gradient-neon text-background shadow-neon border border-primary-glow/30"
                            : message.urgency === "emergency"
                            ? "bg-gradient-glass border-2 border-destructive text-destructive animate-pulse shadow-neon"
                            : message.urgency === "high"
                            ? "bg-gradient-glass border border-warning text-warning shadow-cyber"
                            : "bg-gradient-glass border border-primary/20 text-foreground shadow-glass"
                        }`}>
                          <div className="text-sm leading-relaxed whitespace-pre-wrap font-medium">{message.text}</div>
                          
                          {/* Attachments */}
                          {message.attachments && message.attachments.length > 0 && (
                            <div className="mt-3 space-y-2">
                              {message.attachments.map((attachment, attIndex) => (
                                <div key={attIndex} className="bg-background/20 backdrop-blur-sm rounded-lg p-3 border border-primary/10">
                                  {attachment.type === 'image' && (
                                    <div className="space-y-2">
                                      <img 
                                        src={attachment.url} 
                                        alt={attachment.name}
                                        className="max-w-full h-auto rounded-lg max-h-64 object-cover"
                                      />
                                      <div className="flex items-center gap-2 text-xs opacity-70">
                                        <Image className="h-3 w-3" />
                                        <span>{attachment.name}</span>
                                        {attachment.size && <span>({(attachment.size / 1024 / 1024).toFixed(1)} MB)</span>}
                                      </div>
                                    </div>
                                  )}
                                  
                                  {attachment.type === 'video' && (
                                    <div className="space-y-2">
                                      <video 
                                        src={attachment.url} 
                                        controls
                                        className="max-w-full h-auto rounded-lg max-h-64"
                                      />
                                      <div className="flex items-center gap-2 text-xs opacity-70">
                                        <Video className="h-3 w-3" />
                                        <span>{attachment.name}</span>
                                        {attachment.size && <span>({(attachment.size / 1024 / 1024).toFixed(1)} MB)</span>}
                                      </div>
                                    </div>
                                  )}
                                  
                                  {attachment.type === 'file' && (
                                    <div className="flex items-center gap-3">
                                      <div className="p-2 bg-primary/20 rounded-lg">
                                        <FileText className="h-4 w-4 text-primary" />
                                      </div>
                                      <div className="flex-1">
                                        <div className="text-sm font-medium">{attachment.name}</div>
                                        {attachment.size && (
                                          <div className="text-xs opacity-70">
                                            {(attachment.size / 1024 / 1024).toFixed(1)} MB
                                          </div>
                                        )}
                                      </div>
                                      <Button
                                        variant="ghost"
                                        size="sm"
                                        onClick={() => window.open(attachment.url, '_blank')}
                                        className="text-primary hover:bg-primary/20"
                                      >
                                        <Upload className="h-4 w-4" />
                                      </Button>
                                    </div>
                                  )}
                                </div>
                              ))}
                            </div>
                          )}
                        </div>
                        <div className="text-xs text-muted-foreground mt-2 flex items-center gap-2 opacity-70">
                          <Clock className="h-3 w-3" />
                          {message.timestamp.toLocaleTimeString()}
                        </div>
                      </div>
                    </div>
                  ))}

                  {isTyping && (
                    <div className="flex gap-4 animate-fade-in">
                      <div className="w-12 h-12 rounded-full bg-gradient-cyber text-white flex items-center justify-center shadow-cyber border border-primary-glow/30 animate-pulse-glow">
                        <Bot className="h-6 w-6" />
                      </div>
                      <div className="bg-gradient-glass backdrop-blur-lg p-5 rounded-2xl border border-primary/20 shadow-glass">
                        <div className="flex space-x-2">
                          <div className="w-3 h-3 bg-gradient-neon rounded-full animate-bounce" />
                          <div className="w-3 h-3 bg-gradient-neon rounded-full animate-bounce" style={{animationDelay: "0.2s"}} />
                          <div className="w-3 h-3 bg-gradient-neon rounded-full animate-bounce" style={{animationDelay: "0.4s"}} />
                        </div>
                      </div>
                    </div>
                  )}
                  <div ref={messagesEndRef} />
                </div>
              </ScrollArea>

              {/* Futuristic Chat Input */}
              <div className="border-t border-primary/20 p-6 space-y-4 bg-gradient-to-r from-primary/5 via-transparent to-accent/5">
                {chatMode === "quick" ? (
                  <div className="flex gap-2">
                    <Dialog open={isFileDialogOpen} onOpenChange={setIsFileDialogOpen}>
                      <DialogTrigger asChild>
                        <Button 
                          variant="ghost" 
                          size="sm"
                          className="p-2 rounded-xl bg-gradient-glass backdrop-blur-lg border border-primary/20 hover:border-primary-glow hover:shadow-neon transition-all duration-300"
                        >
                          <Plus className="h-4 w-4 text-primary" />
                        </Button>
                      </DialogTrigger>
                      <DialogContent className="bg-gradient-glass backdrop-blur-xl border border-primary/20">
                        <DialogHeader>
                          <DialogTitle className="text-foreground">Upload Files</DialogTitle>
                        </DialogHeader>
                        <div className="grid grid-cols-1 gap-4 p-4">
                          <Button
                            variant="outline"
                            className="h-16 flex flex-col gap-2 hover:shadow-neon transition-all duration-300"
                            onClick={() => triggerFileUpload('image/*')}
                          >
                            <Image className="h-6 w-6 text-primary" />
                            <span>Upload Images</span>
                          </Button>
                          <Button
                            variant="outline"
                            className="h-16 flex flex-col gap-2 hover:shadow-neon transition-all duration-300"
                            onClick={() => triggerFileUpload('video/*')}
                          >
                            <Video className="h-6 w-6 text-primary" />
                            <span>Upload Videos</span>
                          </Button>
                          <Button
                            variant="outline"
                            className="h-16 flex flex-col gap-2 hover:shadow-neon transition-all duration-300"
                            onClick={() => triggerFileUpload('.pdf,.doc,.docx,.txt')}
                          >
                            <FileText className="h-6 w-6 text-primary" />
                            <span>Upload Documents</span>
                          </Button>
                        </div>
                      </DialogContent>
                    </Dialog>
                    <Input
                      value={inputMessage}
                      onChange={(e) => setInputMessage(e.target.value)}
                      className="flex-1 bg-background/95 backdrop-blur-sm border border-primary/30 focus:border-primary focus:shadow-soft transition-colors duration-200 text-foreground placeholder:text-muted-foreground rounded-xl"
                      placeholder="Type your message... (рдпрд╛ рд╣рд┐рдВрджреА рдореЗрдВ рд▓рд┐рдЦреЗрдВ)"
                      onKeyPress={(e) => e.key === "Enter" && handleSendMessage(inputMessage)}
                    />
                    <Button 
                      variant="ghost" 
                      size="sm"
                      onClick={isRecording ? stopRecording : startRecording}
                      className={`p-2 rounded-xl bg-gradient-glass backdrop-blur-lg border transition-all duration-300 ${
                        isRecording 
                          ? 'border-destructive text-destructive shadow-destructive/20' 
                          : 'border-primary/20 hover:border-primary-glow hover:shadow-neon'
                      }`}
                    >
                      {isRecording ? (
                        <MicOff className="h-4 w-4 animate-pulse" />
                      ) : (
                        <Mic className="h-4 w-4 text-primary" />
                      )}
                    </Button>
                    <Button 
                      onClick={() => handleSendMessage(inputMessage)} 
                      variant="cyber" 
                      className="rounded-xl shadow-neon hover:shadow-cyber"
                    >
                      <Send className="h-4 w-4" />
                    </Button>
                  </div>
                ) : (
                  <div className="space-y-4">
                    <div className="relative">
                      <Textarea
                        value={inputMessage}
                        onChange={(e) => setInputMessage(e.target.value)}
                        placeholder="Share your thoughts in detail... Feel free to write in Hindi or English, whatever feels comfortable. рдореИрдВ рдЖрдкрдХреА рд╣рд░ рдмрд╛рдд рд╕рдордЭреВрдВрдЧрд╛ред"
                        rows={3}
                        className="bg-background/95 backdrop-blur-sm border border-primary/30 focus:border-primary focus:shadow-soft transition-colors duration-200 text-foreground placeholder:text-muted-foreground rounded-xl resize-none pr-20"
                      />
                      <div className="absolute bottom-3 right-3 flex gap-2">
                        <Dialog open={isFileDialogOpen} onOpenChange={setIsFileDialogOpen}>
                          <DialogTrigger asChild>
                            <Button 
                              variant="ghost" 
                              size="sm"
                              className="p-2 rounded-lg bg-gradient-glass backdrop-blur-lg border border-primary/20 hover:border-primary-glow hover:shadow-neon transition-all duration-300"
                            >
                              <Plus className="h-4 w-4 text-primary" />
                            </Button>
                          </DialogTrigger>
                          <DialogContent className="bg-gradient-glass backdrop-blur-xl border border-primary/20">
                            <DialogHeader>
                              <DialogTitle className="text-foreground">Upload Files</DialogTitle>
                            </DialogHeader>
                            <div className="grid grid-cols-1 gap-4 p-4">
                              <Button
                                variant="outline"
                                className="h-16 flex flex-col gap-2 hover:shadow-neon transition-all duration-300"
                                onClick={() => triggerFileUpload('image/*')}
                              >
                                <Image className="h-6 w-6 text-primary" />
                                <span>Upload Images</span>
                              </Button>
                              <Button
                                variant="outline"
                                className="h-16 flex flex-col gap-2 hover:shadow-neon transition-all duration-300"
                                onClick={() => triggerFileUpload('video/*')}
                              >
                                <Video className="h-6 w-6 text-primary" />
                                <span>Upload Videos</span>
                              </Button>
                              <Button
                                variant="outline"
                                className="h-16 flex flex-col gap-2 hover:shadow-neon transition-all duration-300"
                                onClick={() => triggerFileUpload('.pdf,.doc,.docx,.txt')}
                              >
                                <FileText className="h-6 w-6 text-primary" />
                                <span>Upload Documents</span>
                              </Button>
                            </div>
                          </DialogContent>
                        </Dialog>
                        <Button 
                          variant="ghost" 
                          size="sm"
                          onClick={isRecording ? stopRecording : startRecording}
                          className={`p-2 rounded-lg bg-gradient-glass backdrop-blur-lg border transition-all duration-300 ${
                            isRecording 
                              ? 'border-destructive text-destructive shadow-destructive/20' 
                              : 'border-primary/20 hover:border-primary-glow hover:shadow-neon'
                          }`}
                        >
                          {isRecording ? (
                            <MicOff className="h-4 w-4 animate-pulse" />
                          ) : (
                            <Mic className="h-4 w-4 text-primary" />
                          )}
                        </Button>
                      </div>
                    </div>
                    <div className="flex justify-between items-center">
                      <div className="flex gap-3">
                        <Badge variant="outline" className="text-xs bg-gradient-glass backdrop-blur-lg border-primary/30 text-primary hover:shadow-cyber transition-all duration-300">
                          <Shield className="h-3 w-3 mr-1" />
                          Secure & Private
                        </Badge>
                        <Badge variant="outline" className="text-xs bg-gradient-glass backdrop-blur-lg border-primary/30 text-primary hover:shadow-cyber transition-all duration-300">
                          <Clock className="h-3 w-3 mr-1" />
                          24/7 Available
                        </Badge>
                      </div>
                      <Button 
                        onClick={() => handleSendMessage(inputMessage)} 
                        variant="cyber" 
                        className="rounded-xl shadow-neon hover:shadow-cyber"
                      >
                        <Send className="h-4 w-4 mr-2" />
                        Send Message
                      </Button>
                    </div>
                  </div>
                )}
              </div>
            </Card>
          </div>
        </div>
        </div>
      </div>
      
      {/* Hidden file input */}
      <input
        ref={fileInputRef}
        type="file"
        multiple
        onChange={handleFileUpload}
        className="hidden"
      />
    </div>
  );
}